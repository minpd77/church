<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>공유 악보 뷰어 (Drive 이미지 + GitHub)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html, body { margin:0; padding:0; font-family:system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; }
  .wrap { max-width: 1080px; margin: 22px auto; background:#fff; border:1px solid #e9ebf0; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.06); overflow:hidden; }
  header { padding:14px 18px; border-bottom:1px solid #eef0f4; display:flex; align-items:center; gap:12px; }
  header h1 { margin:0; font-size:18px; }
  .spacer { flex:1; }
  .content { display:flex; gap:0; }
  .left { width: 360px; border-right:1px solid #eef0f4; max-height: calc(100vh - 120px); overflow:auto; }
  .right { flex:1; min-height: 70vh; display:flex; flex-direction:column; }

  .controls { padding:12px; border-bottom:1px solid #eef0f4; display:flex; gap:8px; align-items:center; }
  .input { border:1px solid #dcdfe5; border-radius:10px; padding:10px 12px; outline:none; flex:1; }
  .btn { border:0; border-radius:10px; padding:10px 12px; background:#111; color:#fff; cursor:pointer; font-weight:700; }
  .btn.ghost { background:#fff; color:#111; border:1px solid #dcdfe5; }

  ul#list { list-style:none; margin:0; padding:0; }
  ul#list li { padding:12px 14px; border-bottom:1px solid #f0f2f7; display:flex; gap:10px; align-items:center; cursor:pointer; }
  ul#list li:hover { background:#fafbfe; }
  .num { font-weight:800; width:64px; text-align:right; color:#333; }
  .title { flex:1; color:#111; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; }
  .active { background:#eef7ff !important; }

  .viewer { flex:1; display:flex; align-items:center; justify-content:center; background:#111; position:relative; }
  canvas { max-width:100%; max-height:calc(100vh - 180px); background:#111; }
  .note { padding:10px 14px; color:#7a8597; font-size:12px; border-top:1px solid #eef0f4; background:#fbfcff; }

  /* 우클릭/드래그 억제 표시용 */
  .overlay-msg { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,.5); color:#fff; padding:6px 8px; border-radius:8px; font-size:11px; user-select:none; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>공유 악보 뷰어</h1>
    <div class="spacer"></div>
    <button id="reloadBtn" class="btn ghost">목록 새로고침</button>
  </header>

  <div class="content">
    <div class="left">
      <div class="controls">
        <input id="search" class="input" list="hints" placeholder="숫자/제목 검색" />
        <datalist id="hints"></datalist>
      </div>
      <ul id="list"><li style="padding:14px; color:#7a8597;">불러오는 중…</li></ul>
    </div>

    <div class="right">
      <div class="viewer" id="viewer">
        <canvas id="cv" width="1200" height="1600"></canvas>
        <div class="overlay-msg">우클릭/드래그 방지 · 워터마크 적용</div>
      </div>
      <div class="note">
        • 이미지는 Google Drive의 공개 링크를 통해 로드됩니다(원본 완전차단은 불가, 캡처 방지 불가).<br/>
        • 이 뷰어는 <b>Canvas 렌더링</b> + <b>워터마크</b> + <b>우클릭/드래그 억제</b>로 다운로드를 어렵게 만듭니다.
      </div>
    </div>
  </div>
</div>

<script>
/** === 설정: 시트 CSV 주소만 바꾸면 됩니다 ===
 * gviz CSV 예시:
 * https://docs.google.com/spreadsheets/d/스프레드시트ID/gviz/tq?tqx=out:csv&gid=0
 * (시트가 공개여야 함: 파일 > 웹에 게시 or 링크 공개)
 */
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1dVwKCimCCecKM3piJystnUu_pWdtxZSqu2FVMPMnGVs/gviz/tq?tqx=out:csv&gid=0';

/** === 드라이브 이미지 URL 빌더(공개 파일 전제) === */
function driveImageURL(fileId, size=1600){
  // 1순위: googleusercontent CDN (빠르고 <img>/canvas에 적합)
  return `https://lh3.googleusercontent.com/d/${fileId}=w${size}`;
}
function driveImageURLFallback(fileId, size=1600){
  // 2순위: 썸네일 API
  return `https://drive.google.com/thumbnail?id=${fileId}&sz=w${size}`;
}

/** === 상태 === */
let ITEMS = []; // {number, title, fileId}
let FILTERED = [];
let ACTIVE_INDEX = -1;

/** === 도우미 === */
function csvParse(text){
  // 단순 CSV 파서(따옴표 포함 간단 처리). 컬럼: number,title,fileId
  const lines = text.trim().split(/\r?\n/);
  const out = [];
  for (const ln of lines){
    // 가장 단순한 구분(쉼표). 값에 쉼표가 들어가는 경우는 큰따옴표로 감싼다고 가정.
    const cells = [];
    let i=0, cur='', inQ=false;
    while(i<ln.length){
      const ch = ln[i];
      if (inQ){
        if (ch === '"'){
          if (ln[i+1] === '"'){ cur += '"'; i+=2; continue; }
          inQ = false; i++; continue;
        } else { cur += ch; i++; continue; }
      } else {
        if (ch === '"'){ inQ = true; i++; continue; }
        if (ch === ','){ cells.push(cur.trim()); cur=''; i++; continue; }
        cur += ch; i++;
      }
    }
    cells.push(cur.trim());
    out.push(cells);
  }
  return out;
}

function buildHints(items){
  const set = new Set();
  items.forEach(it=>{ set.add(it.number); if (it.title) set.add(it.title); });
  return Array.from(set);
}

function renderList(list){
  const ul = document.getElementById('list');
  ul.innerHTML = '';
  if (!list.length){
    ul.innerHTML = '<li style="padding:14px; color:#7a8597;">항목이 없습니다.</li>';
    return;
  }
  list.forEach((it, idx)=>{
    const li = document.createElement('li');
    li.dataset.idx = idx;
    li.innerHTML = `<div class="num">${it.number}</div><div class="title" title="${it.title||''}">${it.title||'(제목 없음)'}</div>`;
    li.addEventListener('click', ()=> selectIndex(idx));
    ul.appendChild(li);
  });
  highlightActive();
}

function highlightActive(){
  const lis = document.querySelectorAll('#list li');
  lis.forEach(li=> li.classList.remove('active'));
  if (ACTIVE_INDEX>=0 && ACTIVE_INDEX<lis.length) lis[ACTIVE_INDEX].classList.add('active');
}

function selectIndex(idx){
  ACTIVE_INDEX = idx;
  highlightActive();
  const it = FILTERED[idx];
  if (it && it.fileId) loadToCanvas(it);
}

/** === 캔버스 렌더 + 워터마크 === */
async function loadToCanvas(item){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  // 배경 지우기
  ctx.fillStyle = '#111'; ctx.fillRect(0,0,cv.width,cv.height);

  const url1 = driveImageURL(item.fileId, 2000);
  const url2 = driveImageURLFallback(item.fileId, 2000);

  // 이미지 로드 시도
  const img = new Image();
  img.crossOrigin = 'anonymous'; // 시도 (CDN에 따라 무시될 수 있음)
  const src = await tryLoad(img, [url1, url2]);

  // 캔버스 크기 비율 조정
  const maxW = cv.width, maxH = cv.height;
  const ratio = Math.min(maxW / img.width, maxH / img.height);
  const w = Math.max(1, Math.round(img.width * ratio));
  const h = Math.max(1, Math.round(img.height * ratio));
  const x = Math.round((cv.width - w) / 2);
  const y = Math.round((cv.height - h) / 2);

  // 본 이미지
  ctx.imageSmoothingEnabled = true;
  ctx.drawImage(img, x, y, w, h);

  // 워터마크(대각선 반복)
  const stamp = `교회공유용 · ${new Date().toLocaleString()} · ${item.number} ${item.title||''}`;
  drawWatermark(ctx, stamp);
}

function tryLoad(img, urls){
  return new Promise((resolve, reject)=>{
    let i=0;
    const next = ()=>{
      if (i>=urls.length) return reject(new Error('이미지 로드 실패'));
      const u = urls[i++];
      img.onload = ()=> resolve(u);
      img.onerror = next;
      img.src = u;
    };
    next();
  });
}

function drawWatermark(ctx, text){
  const { width:W, height:H } = ctx.canvas;
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.translate(W/2, H/2);
  ctx.rotate(-Math.PI/6); // -30도
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 28px system-ui, -apple-system, "Noto Sans KR", Arial';
  // 타일 반복
  const stepX = 420, stepY = 220;
  for (let y=-H; y<=H; y+=stepY){
    for (let x=-W; x<=W; x+=stepX){
      ctx.fillText(text, x, y);
    }
  }
  ctx.restore();
}

/** === 이벤트: 검색/필터링 === */
const searchEl = document.getElementById('search');
searchEl.addEventListener('input', ()=>{
  const q = searchEl.value.trim().toLowerCase();
  FILTERED = !q ? ITEMS.slice() : ITEMS.filter(it =>
    it.number.toLowerCase().includes(q) ||
    (it.title||'').toLowerCase().includes(q)
  );
  renderList(FILTERED);
  ACTIVE_INDEX = -1;
});

/** === 우클릭/드래그 방지 === */
document.addEventListener('contextmenu', e => {
  const insideCanvas = e.target.id === 'cv';
  if (insideCanvas) e.preventDefault();
});
['dragstart','selectstart','pointerdown'].forEach(evt=>{
  document.getElementById('cv').addEventListener(evt, e => e.preventDefault());
});

/** === 목록 새로고침 === */
document.getElementById('reloadBtn').addEventListener('click', loadSheet);

/** === 시트 로드 === */
async function loadSheet(){
  const listEl = document.getElementById('list');
  listEl.innerHTML = '<li style="padding:14px; color:#7a8597;">불러오는 중…</li>';
  try{
    const res = await fetch(SHEET_CSV_URL, { cache:'no-store' });
    const text = await res.text();
    const rows = csvParse(text);
    // 헤더 판단
    const [h0,h1,h2] = rows[0] || [];
    const headerLooks = (h0||'').toLowerCase().includes('number') || (h1||'').toLowerCase().includes('title') || (h2||'').toLowerCase().includes('file');
    const data = headerLooks ? rows.slice(1) : rows;

    ITEMS = data.map(r => ({
      number: String(r[0]||'').trim(),
      title : String(r[1]||'').trim(),
      fileId: String(r[2]||'').trim()
    })).filter(it => it.number && it.fileId);

    // 힌트 채우기
    const hints = document.getElementById('hints');
    hints.innerHTML = '';
    const set = new Set();
    ITEMS.forEach(it => { set.add(it.number); if (it.title) set.add(it.title); });
    for (const v of set) {
      const op = document.createElement('option'); op.value = v; hints.appendChild(op);
    }

    // 목록/초기 렌더
    FILTERED = ITEMS.slice();
    renderList(FILTERED);
    if (FILTERED.length) { selectIndex(0); }
  } catch(e){
    listEl.innerHTML = '<li style="padding:14px; color:#d33;">시트 로드 실패: '+String(e)+'</li>';
  }
}

/** === 시작 === */
loadSheet();
</script>
</body>
</html>
